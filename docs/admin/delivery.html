<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Livraison</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; }
        #root { width: 100%; min-height: 100vh; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [orders, setOrders] = useState([]);
            const [selected, setSelected] = useState(null);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [messages, setMessages] = useState([]);
            const [newMsg, setNewMsg] = useState('');
            const [file, setFile] = useState(null);
            const [uploading, setUploading] = useState(false);
            const inputRef = useRef(null);
            const messagesRef = useRef(null);

            // Charger les commandes au d√©marrage
            useEffect(() => {
                fetch('/api/orders')
                    .then(r => r.json())
                    .then(data => setOrders(data.filter(o => !o.completed)))
                    .catch(e => console.error('Erreur:', e));
            }, []);

            // Charger les messages quand une commande est s√©lectionn√©e
            useEffect(() => {
                if (selected) {
                    loadMessages();
                    const interval = setInterval(loadMessages, 2000);
                    return () => clearInterval(interval);
                }
            }, [selected]);

            // Scroll auto des messages
            useEffect(() => {
                if (messagesRef.current) {
                    messagesRef.current.scrollTop = messagesRef.current.scrollHeight;
                }
            }, [messages]);

            const loadMessages = async () => {
                if (!selected) return;
                try {
                    const response = await fetch(`/api/orders/${selected.id}/messages`);
                    const data = await response.json();
                    setMessages(data || []);
                } catch (error) {
                    console.error('Erreur chargement messages:', error);
                }
            };

            const handleFileChange = (e) => {
                const f = e.target.files[0];
                if (f && f.name.endsWith('.rar')) {
                    setFile(f);
                } else if (f) {
                    alert('‚ö†Ô∏è Seules les archives RAR sont accept√©es');
                }
            };

            const deliverFile = async () => {
                if (!file || !selected) return;
                setUploading(true);
                const data = new FormData();
                data.append('file', file);
                data.append('orderId', selected.id);
                try {
                    const res = await fetch('/api/orders/deliver', { method: 'POST', body: data });
                    if (res.ok) {
                        setMessages(m => [...m, { 
                            id: Date.now(), 
                            type: 'admin', 
                            content: 'üì¶ Archive livr√©e: ' + file.name,
                            createdAt: new Date().toISOString()
                        }]);
                        setFile(null);
                        if (inputRef.current) inputRef.current.value = '';
                        alert('‚úÖ Archive livr√©e avec succ√®s!');
                    } else {
                        alert('‚ùå Erreur lors de la livraison');
                    }
                } catch (e) {
                    console.error('Erreur:', e);
                    alert('‚ùå Erreur: ' + e.message);
                }
                setUploading(false);
            };

            const sendMsg = async () => {
                if (!newMsg.trim() || !selected) return;
                const msg = newMsg;
                setNewMsg('');
                setMessages(m => [...m, { 
                    id: Date.now(), 
                    type: 'admin', 
                    content: msg,
                    createdAt: new Date().toISOString()
                }]);
                try {
                    await fetch('/api/orders/' + selected.id + '/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: msg })
                    });
                } catch (e) {
                    console.error('Erreur:', e);
                    alert('‚ùå Erreur: ' + e.message);
                }
            };

            return (
                <div className="flex h-screen bg-gray-100">
                    {/* SIDEBAR */}
                    <div className={`transition-all ${sidebarOpen ? 'w-80' : 'w-0'} bg-gray-900 text-white overflow-hidden flex flex-col`}>
                        <div className="p-6 border-b border-gray-700">
                            <h1 className="text-2xl font-bold">üì¶ Livraison</h1>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4">
                            <h2 className="text-gray-300 font-semibold mb-4">Commandes ({orders.length})</h2>
                            {orders.length === 0 ? (
                                <p className="text-gray-500 text-sm">Aucune commande</p>
                            ) : (
                                orders.map(order => (
                                    <div
                                        key={order.id}
                                        onClick={() => setSelected(order)}
                                        className={`p-3 rounded cursor-pointer mb-2 transition ${
                                            selected?.id === order.id ? 'bg-blue-600' : 'bg-gray-800 hover:bg-gray-700'
                                        }`}
                                    >
                                        <div className="font-bold">#{order.id}</div>
                                        <div className="text-sm text-gray-300">{order.businessName}</div>
                                        <div className="text-xs text-gray-400">{order.firstName} {order.lastName}</div>
                                    </div>
                                ))
                            )}
                        </div>
                        <div className="p-4 border-t border-gray-700">
                            <button
                                onClick={() => { 
                                    fetch('/api/auth/logout', { method: 'POST' }); 
                                    window.location.href = '/admin/login'; 
                                }}
                                className="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded font-semibold transition"
                            >
                                D√©connexion
                            </button>
                        </div>
                    </div>

                    {/* MAIN */}
                    <div className="flex-1 flex flex-col">
                        <div className="bg-white shadow p-4 flex items-center justify-between">
                            <button 
                                onClick={() => setSidebarOpen(!sidebarOpen)} 
                                className="px-4 py-2 hover:bg-gray-100 rounded"
                            >
                                ‚ò∞
                            </button>
                            {selected && (
                                <div className="flex-1 ml-4">
                                    <h2 className="font-bold">Commande #{selected.id}</h2>
                                    <p className="text-sm text-gray-600">{selected.businessName}</p>
                                </div>
                            )}
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => window.location.href = '/admin/dashboard'}
                                    className="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition"
                                >
                                    Dashboard
                                </button>
                                <button 
                                    onClick={() => window.location.href = '/admin/manage-admins'}
                                    className="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition"
                                >
                                    Admins
                                </button>
                            </div>
                        </div>

                        {selected ? (
                            <div className="flex-1 flex gap-4 p-6 overflow-hidden">
                                {/* LEFT - FILE DELIVERY */}
                                <div className="flex-1 bg-white rounded shadow p-6 overflow-y-auto">
                                    <h3 className="text-lg font-bold mb-4">üì¶ Livraison des fichiers</h3>
                                    <div className="mb-6 p-4 bg-blue-50 border-2 border-blue-300 rounded">
                                        <input
                                            ref={inputRef}
                                            type="file"
                                            accept=".rar"
                                            onChange={handleFileChange}
                                            className="hidden"
                                        />
                                        <button
                                            onClick={() => inputRef.current?.click()}
                                            className="w-full p-3 border-2 border-dashed border-blue-400 rounded mb-3 text-blue-600 font-semibold hover:bg-blue-100 transition"
                                        >
                                            {file ? `‚úÖ ${file.name}` : 'üìÅ S√©lectionner un fichier RAR'}
                                        </button>
                                        <button
                                            onClick={deliverFile}
                                            disabled={!file || uploading}
                                            className="w-full p-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white rounded font-semibold transition"
                                        >
                                            {uploading ? '‚è≥ Livraison...' : '‚úÖ Livrer'}
                                        </button>
                                    </div>
                                    <div className="p-4 bg-gray-50 rounded">
                                        <h4 className="font-bold mb-2">üìã Instructions</h4>
                                        <p className="text-sm text-gray-700 mb-2">1. T√©l√©charger WinRAR</p>
                                        <p className="text-sm text-gray-700 mb-2">2. Extraire l'archive</p>
                                        <p className="text-sm text-gray-700">3. Upload via FTP en public_html</p>
                                    </div>
                                </div>

                                {/* RIGHT - CHAT */}
                                <div className="w-96 bg-white rounded shadow flex flex-col overflow-hidden">
                                    <div className="p-4 bg-blue-600 text-white">
                                        <h3 className="font-bold">üí¨ Chat</h3>
                                        <p className="text-xs text-blue-100">{selected.email}</p>
                                    </div>
                                    <div ref={messagesRef} className="flex-1 overflow-y-auto p-4 space-y-2 bg-gray-50">
                                        {messages.length === 0 && <p className="text-center text-gray-500 text-sm">Aucun message</p>}
                                        {messages.map(msg => (
                                            <div key={msg.id} className={`flex ${msg.type === 'admin' ? 'justify-end' : 'justify-start'}`}>
                                                <div className={`max-w-xs p-3 rounded text-sm ${msg.type === 'admin' ? 'bg-blue-600 text-white' : 'bg-gray-400 text-gray-900'}`}>
                                                    {msg.content}
                                                    <div className={`text-xs mt-1 ${msg.type === 'admin' ? 'text-blue-100' : 'text-gray-700'}`}>
                                                        {new Date(msg.createdAt).toLocaleTimeString('fr-FR')}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-4 border-t flex gap-2">
                                        <input
                                            type="text"
                                            placeholder="Message..."
                                            value={newMsg}
                                            onChange={(e) => setNewMsg(e.target.value)}
                                            onKeyPress={(e) => e.key === 'Enter' && sendMsg()}
                                            className="flex-1 p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        />
                                        <button 
                                            onClick={sendMsg}
                                            className="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded transition"
                                        >
                                            ‚û§
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="flex-1 flex items-center justify-center text-gray-500">
                                <p>S√©lectionnez une commande</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
